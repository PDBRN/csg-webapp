<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
  <title>CSG Metal Pro</title>
  
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Manrope:wght@400;700;800&display=swap" rel="stylesheet">

  <style>
    :root {
      --bg: #09090b;
      --panel: #18181b;
      --border: #27272a;
      --primary: #f59e0b; 
      --text: #f4f4f5;
      --text-dim: #a1a1aa;
      --font-ui: 'Inter', sans-serif;
    }

    * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
    
    body {
      margin: 0;
      background-color: var(--bg);
      color: var(--text);
      font-family: var(--font-ui);
      padding: 0;
    }

    .app-wrapper {
      display: flex;
      flex-direction: column;
      width: 100%;
      padding-bottom: 120px; /* –ú–µ—Å—Ç–æ –ø–æ–¥ –∫–Ω–æ–ø–∫—É */
    }

    /* Sidebar / Settings */
    .sidebar {
      background: var(--panel);
      padding: 20px;
      border-bottom: 1px solid var(--border);
    }

    .header { margin-bottom: 20px; }
    .header h1 { margin: 0; font-size: 18px; font-weight: 700; color: #fff; }
    .header p { margin: 4px 0 0 0; color: var(--text-dim); font-size: 12px; }

    .control-group { margin-bottom: 20px; }
    .control-group label { display: block; margin-bottom: 8px; font-size: 12px; font-weight: 600; color: var(--text-dim); text-transform: uppercase; letter-spacing: 0.5px; }

    input[type="text"], textarea, select {
      width: 100%;
      background: #0f0f11;
      border: 1px solid var(--border);
      color: var(--text);
      padding: 12px;
      border-radius: 12px;
      font-family: inherit;
      font-size: 14px;
      margin-bottom: 8px;
    }
    textarea { resize: none; height: 80px; }

    /* File Drop */
    .file-drop {
      border: 1px dashed var(--border);
      border-radius: 12px;
      padding: 16px;
      text-align: center;
      background: rgba(255,255,255,0.02);
      cursor: pointer;
    }
    .file-drop span { font-size: 13px; color: var(--primary); font-weight: 500; }
    input[type="file"] { display: none; }

    /* Logo Presets */
    .logo-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    .logo-btn {
      background: #27272a;
      border: 1px solid transparent;
      color: #fff;
      padding: 8px 12px;
      border-radius: 8px;
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      flex: 1 1 auto;
      text-align: center;
      transition: 0.2s;
    }
    .logo-btn.active {
      background: var(--primary);
      color: #000;
      font-weight: 700;
    }
    .logo-btn:active { transform: scale(0.95); }

    /* Color & Background Row */
    .row { display: flex; gap: 12px; align-items: center; }
    
    .color-wrapper {
      position: relative;
      width: 50px;
      height: 50px;
      border-radius: 50%;
      overflow: hidden;
      border: 2px solid var(--border);
      flex-shrink: 0;
    }
    input[type="color"] {
      position: absolute;
      top: -50%; left: -50%;
      width: 200%; height: 200%;
      padding: 0; margin: 0;
      border: none;
      cursor: pointer;
    }

    /* Generate Button (Floating) */
    .btn-generate {
      position: fixed;
      bottom: 20px;
      left: 20px;
      width: calc(100% - 40px);
      background: var(--primary);
      color: #000;
      border: none;
      padding: 16px;
      border-radius: 16px;
      font-weight: 800;
      font-size: 16px;
      cursor: pointer;
      box-shadow: 0 10px 30px rgba(0,0,0,0.5);
      z-index: 100;
      text-transform: uppercase;
    }
    .btn-generate:active { transform: scale(0.96); }

    /* Previews */
    .preview-grid {
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 30px;
    }

    .card {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 10px;
    }
    
    .card-header { 
      display: flex; justify-content: space-between; 
      margin-bottom: 10px; padding: 0 4px; 
    }
    .card-title { font-size: 12px; font-weight: 600; color: #fff; }
    .badge { font-size: 10px; background: #27272a; padding: 2px 6px; border-radius: 4px; color: #888; }

    canvas {
      width: 100%;
      height: auto;
      border-radius: 8px;
      display: block;
      background: #000;
    }

    .btn-share {
      margin-top: 10px;
      background: #333;
      color: #fff;
      border: none;
      width: 100%;
      padding: 12px;
      border-radius: 8px;
      font-weight: 600;
      font-size: 13px;
    }
  </style>
</head>
<body>

<div class="app-wrapper">
  <!-- SETTINGS -->
  <div class="sidebar">
    <div class="header">
      <h1>CSG Metal Pro</h1>
      <p>–ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä —Å—Ç–æ—Ä–∏—Å v3.0</p>
    </div>

    <!-- 1. PHOTOS -->
    <div class="control-group">
      <label>1. –§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏</label>
      <div class="file-drop" onclick="document.getElementById('imgInput').click()">
        <span id="fileLabel">üì∏ –í—ã–±—Ä–∞—Ç—å —Ñ–æ—Ç–æ (1-4 —à—Ç)</span>
        <input type="file" id="imgInput" multiple accept="image/*" onchange="updateFileLabel(this)">
      </div>
    </div>

    <!-- 2. LOGO PRESETS -->
    <div class="control-group">
      <label>2. –õ–æ–≥–æ—Ç–∏–ø</label>
      <div class="logo-grid" id="logoContainer">
        <button class="logo-btn active" onclick="selectLogo(this, 'none')">–ë–µ–∑ –ª–æ–≥–æ</button>
        <!-- üî¥ –ó–ê–ú–ï–ù–ò –°–°–´–õ–ö–ò –ù–ê –°–í–û–ò PNG –õ–û–ì–û–¢–ò–ü–´ -->
        <button class="logo-btn" onclick="selectLogo(this, 'csg')">–¶–°–ì</button>
        <button class="logo-btn" onclick="selectLogo(this, 'mstore')">M-Store</button>
        <button class="logo-btn" onclick="selectLogo(this, 'pss')">–ü–°–°</button>
        <button class="logo-btn" onclick="selectLogo(this, 'cm')">–¶–ú</button>
        <button class="logo-btn" onclick="selectLogo(this, 'polymers')">–ü–æ–ª–∏–º–µ—Ä—ã</button>
        <button class="logo-btn" onclick="selectLogo(this, 'horeca')">–•–æ—Ä–µ–∫–∞</button>
        <button class="logo-btn" onclick="selectLogo(this, 'custom')">–ó–∞–≥—Ä—É–∑–∏—Ç—å...</button>
      </div>
      <input type="file" id="customLogoInput" accept="image/*" style="display:none" onchange="handleCustomLogo(this)">
    </div>

    <!-- 3. SPLIT TEXT -->
    <div class="control-group">
      <label>3. –¢–µ–∫—Å—Ç–æ–≤—ã–π –±–ª–æ–∫</label>
      <input type="text" id="txtTitle" placeholder="–ó–∞–≥–æ–ª–æ–≤–æ–∫" value="–ê—Ä–º–∞—Ç—É—Ä–∞ –ê500–°">
      <textarea id="txtDesc" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ">–í –Ω–∞–ª–∏—á–∏–∏ –≤—Å–µ –¥–∏–∞–º–µ—Ç—Ä—ã. –†–µ–∑–∫–∞ –≤ —Ä–∞–∑–º–µ—Ä. –î–æ—Å—Ç–∞–≤–∫–∞ –≤ –¥–µ–Ω—å –∑–∞–∫–∞–∑–∞.</textarea>
      <input type="text" id="txtBtn" placeholder="–¢–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏" value="–†–∞—Å—Å—á–∏—Ç–∞—Ç—å —Å—Ç–æ–∏–º–æ—Å—Ç—å üî•">
    </div>

    <!-- 4. STYLE -->
    <div class="row control-group">
      <div>
        <label>–ê–∫—Ü–µ–Ω—Ç</label>
        <div class="color-wrapper">
          <input type="color" id="accentColor" value="#f59e0b">
        </div>
      </div>
      <div style="flex-grow: 1;">
        <label>–§–æ–Ω</label>
        <select id="bgStyle">
          <option value="blur">Blur (–†–∞–∑–º—ã—Ç–∏–µ)</option>
          <option value="dark">–¢—ë–º–Ω—ã–π (–°–∫–ª–∞–¥)</option>
          <option value="clean">–°–≤–µ—Ç–ª—ã–π (–ë–µ—Ç–æ–Ω)</option>
        </select>
      </div>
    </div>
  </div>

  <!-- PREVIEWS -->
  <div class="preview-grid" id="gridArea" style="display:none;">
    <div class="card"><div class="card-header"><span class="card-title">V1. Classic Hero</span></div><canvas id="c1" width="1080" height="1920"></canvas><button class="btn-share" onclick="shareCanvas('c1')">–ü–æ–¥–µ–ª–∏—Ç—å—Å—è / –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button></div>
    <div class="card"><div class="card-header"><span class="card-title">V2. Grid (Collage)</span><span class="badge">Multi-img</span></div><canvas id="c2" width="1080" height="1920"></canvas><button class="btn-share" onclick="shareCanvas('c2')">–ü–æ–¥–µ–ª–∏—Ç—å—Å—è / –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button></div>
    <div class="card"><div class="card-header"><span class="card-title">V9. Gallery (New)</span><span class="badge">4 –§–æ—Ç–æ</span></div><canvas id="c9" width="1080" height="1920"></canvas><button class="btn-share" onclick="shareCanvas('c9')">–ü–æ–¥–µ–ª–∏—Ç—å—Å—è / –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button></div>
    <div class="card"><div class="card-header"><span class="card-title">V3. Big Bold</span></div><canvas id="c3" width="1080" height="1920"></canvas><button class="btn-share" onclick="shareCanvas('c3')">–ü–æ–¥–µ–ª–∏—Ç—å—Å—è / –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button></div>
    <div class="card"><div class="card-header"><span class="card-title">V4. Product Card</span></div><canvas id="c4" width="1080" height="1920"></canvas><button class="btn-share" onclick="shareCanvas('c4')">–ü–æ–¥–µ–ª–∏—Ç—å—Å—è / –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button></div>
    <div class="card"><div class="card-header"><span class="card-title">V5. Industrial</span><span class="badge">Split</span></div><canvas id="c5" width="1080" height="1920"></canvas><button class="btn-share" onclick="shareCanvas('c5')">–ü–æ–¥–µ–ª–∏—Ç—å—Å—è / –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button></div>
    <div class="card"><div class="card-header"><span class="card-title">V6. Hot Sale</span></div><canvas id="c6" width="1080" height="1920"></canvas><button class="btn-share" onclick="shareCanvas('c6')">–ü–æ–¥–µ–ª–∏—Ç—å—Å—è / –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button></div>
    <div class="card"><div class="card-header"><span class="card-title">V7. Geometric</span></div><canvas id="c7" width="1080" height="1920"></canvas><button class="btn-share" onclick="shareCanvas('c7')">–ü–æ–¥–µ–ª–∏—Ç—å—Å—è / –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button></div>
    <div class="card"><div class="card-header"><span class="card-title">V8. Frame</span></div><canvas id="c8" width="1080" height="1920"></canvas><button class="btn-share" onclick="shareCanvas('c8')">–ü–æ–¥–µ–ª–∏—Ç—å—Å—è / –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button></div>
  </div>

  <button class="btn-generate" id="renderBtn">–ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å</button>
</div>

<script>
  // --- SETUP ---
  const tg = window.Telegram.WebApp;
  tg.ready();
  tg.expand();
  tg.setHeaderColor('#18181b');
  tg.setBackgroundColor('#09090b');

  // üî¥ –°–°–´–õ–ö–ò –ù–ê –õ–û–ì–û–¢–ò–ü–´ (–ó–∞–ø–æ–ª–Ω–∏ —Ä–µ–∞–ª—å–Ω—ã–º–∏ —Å—Å—ã–ª–∫–∞–º–∏ –Ω–∞ PNG)
  const LOGO_URLS = {
    'none': null,
    'csg': 'https://pdbrn.github.io/csg-webapp/assets/logo_csg.png',
    'mstore': 'https://pdbrn.github.io/csg-webapp/assets/logo_mstore.png',
    'pss': 'https://pdbrn.github.io/csg-webapp/assets/logo_pss.png',
    'cm': 'https://pdbrn.github.io/csg-webapp/assets/logo_cm.png',
    'polymers': 'https://pdbrn.github.io/csg-webapp/assets/logo_polymers.png',
    'horeca': 'https://pdbrn.github.io/csg-webapp/assets/logo_horeca.png'
  };

  const W = 1080, H = 1920;
  const FONT_MANROPE = "'Manrope', sans-serif";
  const FONT_INTER = "'Inter', sans-serif";

  const state = {
    images: [],
    logo: null,
    title: "",
    desc: "",
    cta: "",
    accent: "#f59e0b",
  };

  // --- UI ---
  function updateFileLabel(input) {
    document.getElementById('fileLabel').innerText = input.files.length 
      ? `–§–∞–π–ª–æ–≤: ${input.files.length}` 
      : "üì∏ –í—ã–±—Ä–∞—Ç—å —Ñ–æ—Ç–æ (1-4 —à—Ç)";
  }

  async function selectLogo(btn, key) {
    document.querySelectorAll('.logo-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    if (key === 'custom') { document.getElementById('customLogoInput').click(); return; }
    if (key === 'none') { state.logo = null; } 
    else { state.logo = await loadImage(LOGO_URLS[key]); }
  }

  async function handleCustomLogo(input) {
    if(input.files && input.files[0]) {
      state.logo = await loadImage(URL.createObjectURL(input.files[0]));
      document.querySelector('.logo-btn[onclick*="custom"]').innerText = "–ó–∞–≥—Ä—É–∂–µ–Ω–æ ‚úÖ";
      document.querySelector('.logo-btn[onclick*="custom"]').classList.add('active');
    }
  }

  // --- DRAW HELPERS ---
  function getCtx(id) {
    const c = document.getElementById(id);
    const ctx = c.getContext('2d', { alpha: false });
    ctx.filter = 'none'; ctx.globalAlpha = 1; ctx.setTransform(1, 0, 0, 1, 0, 0); 
    return ctx;
  }

  function loadImage(src) {
    return new Promise((resolve) => {
      const img = new Image();
      img.crossOrigin = "anonymous";
      img.onload = () => resolve(img);
      img.onerror = () => resolve(null);
      img.src = src;
    });
  }

  function wrapText(ctx, text, maxWidth) {
    if(!text) return [];
    const words = text.split(' ');
    let lines = [], currentLine = words[0];
    for (let i = 1; i < words.length; i++) {
      const word = words[i];
      const width = ctx.measureText(currentLine + " " + word).width;
      if (width < maxWidth) currentLine += " " + word;
      else { lines.push(currentLine); currentLine = word; }
    }
    lines.push(currentLine);
    return lines;
  }

  function drawImageCover(ctx, img, x, y, w, h, r=0) {
    if (!img) return;
    ctx.save();
    if (r > 0) { ctx.beginPath(); ctx.roundRect(x, y, w, h, r); ctx.clip(); }
    const scale = Math.max(w / img.width, h / img.height);
    const sw = w / scale, sh = h / scale;
    ctx.drawImage(img, (img.width-sw)/2, (img.height-sh)/2, sw, sh, x, y, w, h);
    ctx.restore();
  }

  function drawLogoBookmark(ctx, xCenter) {
    if (!state.logo) return;
    const tagW = 200, tagH = 140, r = 20;
    const x = xCenter - tagW/2;
    ctx.save();
    ctx.fillStyle = '#ffffff';
    ctx.shadowColor = 'rgba(0,0,0,0.3)'; ctx.shadowBlur = 20; ctx.shadowOffsetY = 5;
    ctx.beginPath();
    ctx.moveTo(x, 0); ctx.lineTo(x + tagW, 0);
    ctx.lineTo(x + tagW, tagH - r);
    ctx.arcTo(x + tagW, tagH, x + tagW - r, tagH, r);
    ctx.lineTo(x + r, tagH);
    ctx.arcTo(x, tagH, x, tagH - r, r);
    ctx.closePath();
    ctx.fill();
    ctx.shadowBlur = 0;
    const pad = 20;
    const maxW = tagW - pad*2, maxH = tagH - pad*2;
    const scale = Math.min(maxW/state.logo.width, maxH/state.logo.height);
    const fw = state.logo.width * scale, fh = state.logo.height * scale;
    ctx.drawImage(state.logo, x+(tagW-fw)/2, (tagH-fh)/2, fw, fh);
    ctx.restore();
  }

  function drawBackground(ctx) {
    const mode = document.getElementById('bgStyle').value;
    if (mode === 'clean') {
      ctx.fillStyle = '#e5e7eb'; ctx.fillRect(0,0,W,H);
    } else if (mode === 'blur' && state.images.length > 0) {
      ctx.drawImage(state.images[0], 0, 0, W, H);
      ctx.fillStyle = 'rgba(10,10,12,0.85)'; ctx.fillRect(0,0,W,H);
      ctx.fillStyle = 'rgba(0,0,0,0.5)'; ctx.fillRect(0,0,W,H); 
    } else {
      ctx.fillStyle = '#111'; ctx.fillRect(0,0,W,H);
    }
  }

  // --- RENDERERS ---

  function renderV1(ctx) {
    drawBackground(ctx);
    if (state.images[0]) {
      drawImageCover(ctx, state.images[0], 0, 0, W, H);
      const g = ctx.createLinearGradient(0, H/2, 0, H);
      g.addColorStop(0, 'transparent'); g.addColorStop(1, '#000');
      ctx.fillStyle = g; ctx.fillRect(0,0,W,H);
    }
    drawLogoBookmark(ctx, W/2);
    let y = H - 100;
    if (state.cta) {
      ctx.font = `700 40px ${FONT_INTER}`;
      const btnW = ctx.measureText(state.cta).width + 80;
      y -= 120;
      ctx.fillStyle = state.accent;
      ctx.beginPath(); ctx.roundRect(60, y, btnW, 100, 16); ctx.fill();
      ctx.fillStyle = '#000'; ctx.textAlign='center'; ctx.textBaseline='middle';
      ctx.fillText(state.cta, 60+btnW/2, y+50);
      y -= 40;
    }
    if(state.desc) {
      ctx.font = `500 42px ${FONT_INTER}`; ctx.fillStyle = '#d4d4d8'; ctx.textAlign='left';
      wrapText(ctx, state.desc, W-120).reverse().forEach(line => { y -= 55; ctx.fillText(line, 60, y); });
      y -= 30;
    }
    if(state.title) {
      ctx.font = `800 90px ${FONT_MANROPE}`; ctx.fillStyle = '#fff';
      wrapText(ctx, state.title, W-120).reverse().forEach(line => { y -= 100; ctx.fillText(line, 60, y); });
    }
  }

  function renderV2(ctx) {
    ctx.fillStyle = '#111'; ctx.fillRect(0,0,W,H);
    const pad=40, gap=20, areaH=H*0.55;
    const imgs = state.images.slice(0,4);
    
    if(imgs.length === 1) drawImageCover(ctx, imgs[0], pad, pad, W-pad*2, areaH);
    else if(imgs.length === 2) {
      const h = (areaH-gap)/2;
      drawImageCover(ctx, imgs[0], pad, pad, W-pad*2, h);
      drawImageCover(ctx, imgs[1], pad, pad+h+gap, W-pad*2, h);
    } else if(imgs.length >= 3) {
      const mainH = areaH * 0.6;
      drawImageCover(ctx, imgs[0], pad, pad, W-pad*2, mainH);
      const subW = (W-pad*2-gap)/2;
      drawImageCover(ctx, imgs[1], pad, pad+mainH+gap, subW, areaH-mainH-gap);
      if(imgs[2]) drawImageCover(ctx, imgs[2], pad+subW+gap, pad+mainH+gap, subW, areaH-mainH-gap);
      if(imgs[3]) { /* v2 only supports 3 in this layout, v9 supports 4 */ }
    }
    drawLogoBookmark(ctx, W/2);
    const centerBlockY = areaH + (H-areaH)/2;
    ctx.textAlign = 'center'; ctx.textBaseline='middle';
    let ty = centerBlockY - 100;
    if(state.title) {
      ctx.font = `800 75px ${FONT_MANROPE}`; ctx.fillStyle='#fff';
      wrapText(ctx, state.title, W-100).forEach(l => { ctx.fillText(l, W/2, ty); ty+=85; });
    }
    if(state.desc) {
      ty+=20; ctx.font=`400 38px ${FONT_INTER}`; ctx.fillStyle='#a1a1aa';
      wrapText(ctx, state.desc, W-100).forEach(l => { ctx.fillText(l, W/2, ty); ty+=50; });
    }
    if(state.cta) {
      ty+=60; ctx.font=`700 42px ${FONT_INTER}`; ctx.fillStyle=state.accent;
      ctx.fillText(state.cta, W/2, ty);
      ctx.fillRect(W/2 - 100, ty+30, 200, 4);
    }
  }

  // --- V9: NEW GALLERY (for 4 images) ---
  function renderV9(ctx) {
    ctx.fillStyle='#09090b'; ctx.fillRect(0,0,W,H);
    
    // Layout: 1 Big Top, 3 Small Bottom strip
    const bigH = H * 0.50;
    const stripH = H * 0.18; 
    const gap = 15;
    
    if(state.images[0]) drawImageCover(ctx, state.images[0], 0, 0, W, bigH);
    
    // 3 Small images row
    const subW = (W - (gap*4)) / 3;
    const startY = bigH + gap;
    
    // –†–∏—Å—É–µ–º 2, 3 –∏ 4 –∫–∞—Ä—Ç–∏–Ω–∫—É –µ—Å–ª–∏ –µ—Å—Ç—å
    for(let i=0; i<3; i++) {
        const img = state.images[i+1];
        const x = gap + i * (subW + gap);
        if(img) {
            drawImageCover(ctx, img, x, startY, subW, stripH, 12);
        } else {
            // Placeholder empty slot
            ctx.fillStyle = '#18181b'; 
            ctx.beginPath(); ctx.roundRect(x, startY, subW, stripH, 12); ctx.fill();
        }
    }
    
    drawLogoBookmark(ctx, W/2);
    
    const textStart = startY + stripH + 60;
    ctx.textAlign = 'center'; ctx.textBaseline='top';
    let ty = textStart;

    if(state.title) {
        ctx.fillStyle='#fff'; ctx.font=`800 80px ${FONT_MANROPE}`;
        wrapText(ctx, state.title, W-80).forEach(l => { ctx.fillText(l, W/2, ty); ty+=90; });
    }
    if(state.desc) {
        ty+=20; ctx.fillStyle='#a1a1aa'; ctx.font=`500 40px ${FONT_INTER}`;
        wrapText(ctx, state.desc, W-100).forEach(l => { ctx.fillText(l, W/2, ty); ty+=50; });
    }
    if(state.cta) {
        ty+=50;
        ctx.fillStyle=state.accent; 
        const btnW = ctx.measureText(state.cta).width + 100;
        ctx.beginPath(); ctx.roundRect(W/2 - btnW/2, ty, btnW, 100, 50); ctx.fill();
        
        ctx.fillStyle='#000'; ctx.font=`700 38px ${FONT_INTER}`; ctx.textBaseline='middle';
        ctx.fillText(state.cta, W/2, ty+50);
    }
  }

  function renderV3(ctx) {
    if(state.images[0]) {
      drawImageCover(ctx, state.images[0], 0,0,W,H);
      ctx.fillStyle = 'rgba(0,0,0,0.85)'; ctx.fillRect(0,0,W,H);
    } else { ctx.fillStyle='#111'; ctx.fillRect(0,0,W,H); }
    
    drawLogoBookmark(ctx, W/2);
    
    ctx.textAlign='center'; ctx.textBaseline='middle';
    let ty = H/2 - 100;
    
    if(state.title) {
      ctx.font = `900 120px ${FONT_MANROPE}`; ctx.fillStyle='#fff';
      wrapText(ctx, state.title.toUpperCase(), W-60).forEach(l => {
        ctx.fillText(l, W/2, ty); ty+=120;
      });
    }
    
    ctx.fillStyle = state.accent; ctx.fillRect(W/2-60, ty, 120, 8); ty+=80;

    if(state.desc) {
      ctx.font = `500 48px ${FONT_INTER}`; ctx.fillStyle='#ccc';
      wrapText(ctx, state.desc, W-150).forEach(l => {
         ctx.fillText(l, W/2, ty); ty+=60;
      });
    }

    // FIX: Dynamic Button Width
    if(state.cta) {
      ty = H - 250;
      ctx.save(); ctx.translate(W/2, ty);
      ctx.font=`700 40px ${FONT_INTER}`;
      const btnW = ctx.measureText(state.cta).width + 120;
      
      ctx.transform(1,0,-0.2,1,0,0);
      ctx.fillStyle=state.accent; 
      // –¶–µ–Ω—Ç—Ä–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É –ø–æ —à–∏—Ä–∏–Ω–µ —Ç–µ–∫—Å—Ç–∞
      ctx.fillRect(-btnW/2, -50, btnW, 100);
      
      ctx.setTransform(1,0,0,1,W/2,ty);
      ctx.fillStyle='#000'; 
      ctx.fillText(state.cta, 0, 5);
      ctx.restore();
    }
  }

  function renderV4(ctx) {
     drawBackground(ctx);
     const cX=40, cY=(H*0.15), cW=W-80, cH=H*0.7;
     ctx.shadowColor='rgba(0,0,0,0.5)'; ctx.shadowBlur=40;
     ctx.fillStyle = document.getElementById('bgStyle').value === 'clean' ? '#fff' : '#18181b';
     ctx.beginPath(); ctx.roundRect(cX, cY, cW, cH, 24); ctx.fill(); ctx.shadowBlur=0;
     ctx.save(); ctx.clip();
     if(state.images[0]) drawImageCover(ctx, state.images[0], cX, cY, cW, cH*0.55);
     
     let ty = cY + cH*0.55 + 60;
     const tx = cX + 50, tW = cW - 100;
     const isLight = document.getElementById('bgStyle').value === 'clean';
     ctx.textAlign='left'; ctx.textBaseline='top';
     
     if(state.title) {
       ctx.fillStyle = isLight ? '#000' : '#fff'; ctx.font = `800 55px ${FONT_MANROPE}`;
       wrapText(ctx, state.title, tW).forEach(l => { ctx.fillText(l, tx, ty); ty+=65; });
     }
     if(state.desc) {
       ty+=20; ctx.fillStyle = isLight ? '#555' : '#a1a1aa'; ctx.font = `400 34px ${FONT_INTER}`;
       wrapText(ctx, state.desc, tW).slice(0,3).forEach(l => { ctx.fillText(l, tx, ty); ty+=45; });
     }
     if(state.cta) {
       const btnY = cY + cH - 140;
       ctx.fillStyle=state.accent; ctx.fillRect(tx, btnY, tW, 90);
       ctx.fillStyle='#000'; ctx.textAlign='center'; ctx.textBaseline='middle';
       ctx.font=`700 32px ${FONT_INTER}`;
       ctx.fillText(state.cta, tx+tW/2, btnY+45);
     }
     ctx.restore();
     drawLogoBookmark(ctx, W/2);
  }

  function renderV5(ctx) {
    const isClean = document.getElementById('bgStyle').value === 'clean';
    ctx.fillStyle = isClean ? '#f3f4f6' : '#111'; ctx.fillRect(0,0,W,H);
    
    // FIX: Support 2 images split
    const splitH = H*0.6;
    if(state.images.length > 1) {
        // Split vertical
        drawImageCover(ctx, state.images[0], 0, 0, W/2, splitH);
        drawImageCover(ctx, state.images[1], W/2, 0, W/2, splitH);
        ctx.fillStyle='#fff'; ctx.fillRect(W/2-2, 0, 4, splitH);
    } else if(state.images[0]) {
        drawImageCover(ctx, state.images[0], 0, 0, W, splitH);
    }
    
    drawLogoBookmark(ctx, W/2);

    // FIX: Lower text position and add Desc
    let ty = splitH + 80;
    ctx.textAlign='center'; ctx.textBaseline='top';
    
    if(state.title) {
       ctx.fillStyle = isClean ? '#000' : '#fff';
       ctx.font = `800 70px ${FONT_MANROPE}`;
       wrapText(ctx, state.title, W-80).forEach(l => { ctx.fillText(l, W/2, ty); ty+=80; });
    }
    
    ctx.fillStyle=state.accent; ctx.fillRect(W/2-40, ty+15, 80, 6); ty+=50;
    
    if(state.desc) {
       ctx.fillStyle = isClean ? '#555' : '#a1a1aa';
       ctx.font = `500 38px ${FONT_INTER}`;
       wrapText(ctx, state.desc, W-120).forEach(l => { ctx.fillText(l, W/2, ty); ty+=45; });
    }
    
    if(state.cta) {
       ty += 40;
       ctx.fillStyle = isClean ? '#222' : '#ccc';
       ctx.font=`600 40px ${FONT_INTER}`;
       ctx.fillText(state.cta + " ‚Üí", W/2, ty);
    }
  }

  function renderV6(ctx) {
     ctx.fillStyle='#09090b'; ctx.fillRect(0,0,W,H);
     const imgH = H*0.55;
     if(state.images[0]) {
       drawImageCover(ctx, state.images[0], 0,0,W,imgH);
       const g = ctx.createLinearGradient(0, imgH-200, 0, imgH);
       g.addColorStop(0, 'transparent'); g.addColorStop(1, '#09090b');
       ctx.fillStyle=g; ctx.fillRect(0,imgH-200,W,200);
     }
     drawLogoBookmark(ctx, 150);
     
     const bx=W-140, by=imgH;
     ctx.beginPath(); ctx.arc(bx, by, 90, 0, Math.PI*2);
     ctx.fillStyle=state.accent; ctx.fill();
     ctx.font='80px serif'; ctx.textAlign='center'; ctx.textBaseline='middle';
     ctx.fillText('üî•', bx, by+5);

     // FIX: Lower Text
     let ty = imgH + 120;
     if(state.title) {
       ctx.textAlign='left'; ctx.textBaseline='top'; ctx.fillStyle='#fff';
       ctx.font=`800 100px ${FONT_MANROPE}`;
       wrapText(ctx, state.title.toUpperCase(), W-100).forEach(l => {
         ctx.fillText(l, 50, ty); ty+=100;
       });
     }
     
     ty+=20; ctx.fillStyle='#333'; ctx.fillRect(50, ty, W-100, 2); 
     ctx.fillStyle=state.accent; ctx.fillRect(50, ty-4, 150, 10); ty+=60;

     if(state.desc) {
       ctx.fillStyle='#a1a1aa'; ctx.font=`500 40px ${FONT_INTER}`;
       wrapText(ctx, state.desc, W-100).forEach(l => { ctx.fillText(l, 50, ty); ty+=50; });
     }
  }

  function renderV7(ctx) {
    ctx.fillStyle='#111'; ctx.fillRect(0,0,W,H);
    if(state.images[0]) {
      ctx.save();
      ctx.beginPath(); ctx.moveTo(0,0); ctx.lineTo(W,0); ctx.lineTo(W, H*0.65); ctx.lineTo(0, H*0.55); ctx.closePath();
      ctx.clip();
      drawImageCover(ctx, state.images[0], 0, 0, W, H*0.7);
      ctx.restore();
      ctx.strokeStyle=state.accent; ctx.lineWidth=8;
      ctx.beginPath(); ctx.moveTo(0,H*0.55); ctx.lineTo(W,H*0.65); ctx.stroke();
    }
    drawLogoBookmark(ctx, W-150);
    
    // FIX: Coordinates
    let ty = H*0.65 + 80;
    ctx.textAlign='left'; ctx.textBaseline='top';
    
    if(state.title) {
       ctx.fillStyle='#fff'; ctx.font=`800 90px ${FONT_MANROPE}`;
       wrapText(ctx, state.title, W-100).forEach(l => { ctx.fillText(l, 60, ty); ty+=95; });
    }
    if(state.desc) {
       ty+=30; ctx.fillStyle='#888'; ctx.font=`500 38px ${FONT_INTER}`;
       wrapText(ctx, state.desc, W-100).forEach(l => { ctx.fillText(l, 60, ty); ty+=45; });
    }
    if(state.cta) {
       const by = H-180;
       ctx.strokeStyle='#fff'; ctx.lineWidth=3; ctx.strokeRect(60, by, W-120, 100);
       ctx.fillStyle=state.accent; ctx.textAlign='center'; ctx.textBaseline='middle'; ctx.font=`700 36px ${FONT_MANROPE}`;
       ctx.fillText(state.cta, W/2, by+55);
    }
  }

  function renderV8(ctx) {
    if(state.images[0]) {
      drawImageCover(ctx, state.images[0], 0,0,W,H);
      ctx.fillStyle='rgba(0,0,0,0.65)'; ctx.fillRect(0,0,W,H);
    } else { ctx.fillStyle='#222'; ctx.fillRect(0,0,W,H); }
    drawLogoBookmark(ctx, W/2);

    const fx=50, fy=200, fw=W-100, fh=H-300;
    ctx.strokeStyle='rgba(255,255,255,0.3)'; ctx.lineWidth=2; ctx.strokeRect(fx,fy,fw,fh);
    
    ctx.fillStyle=state.accent; const s=60;
    ctx.fillRect(fx-4, fy-4, s, 8); ctx.fillRect(fx-4, fy-4, 8, s);
    ctx.fillRect(fx+fw-s, fy-4, s+8, 8); ctx.fillRect(fx+fw, fy-4, 8, s);
    ctx.fillRect(fx-4, fy+fh, s, 8); ctx.fillRect(fx-4, fy+fh-s, 8, s+8);
    ctx.fillRect(fx+fw-s, fy+fh, s+8, 8); ctx.fillRect(fx+fw, fy+fh-s, 8, s+8);

    const cy = fy+fh/2;
    ctx.textAlign='center'; ctx.textBaseline='middle';
    
    // FIX: Add Desc
    let ty = cy - 80; 
    if(state.title) {
      ctx.fillStyle='#fff'; ctx.font=`800 80px ${FONT_MANROPE}`;
      const lines = wrapText(ctx, state.title.toUpperCase(), fw-80);
      ty -= (lines.length*90)/2;
      lines.forEach(l => { ctx.fillText(l, W/2, ty); ty+=90; });
    }
    
    if(state.desc) {
      ty+=10; ctx.fillStyle='#d4d4d8'; ctx.font=`500 40px ${FONT_INTER}`;
      wrapText(ctx, state.desc, fw-100).forEach(l => { ctx.fillText(l, W/2, ty); ty+=50; });
    }
    
    if(state.cta) {
      const by = fy+fh - 140;
      ctx.fillStyle=state.accent; ctx.fillRect(fx+80, by, fw-160, 90);
      ctx.fillStyle='#000'; ctx.font=`700 36px ${FONT_MANROPE}`;
      ctx.fillText(state.cta, W/2, by+45);
    }
  }

  // --- ACTIONS ---
  async function generate() {
    const btn = document.getElementById('renderBtn');
    btn.innerText = "‚è≥ –†–∏—Å—É—é...";
    
    state.title = document.getElementById('txtTitle').value;
    state.desc = document.getElementById('txtDesc').value;
    state.cta = document.getElementById('txtBtn').value;
    state.accent = document.getElementById('accentColor').value;
    
    const files = document.getElementById('imgInput').files;
    if (files.length) {
      state.images = await Promise.all(Array.from(files).map(f => loadImage(URL.createObjectURL(f))));
    }
    
    await document.fonts.ready;

    renderV1(getCtx('c1'));
    renderV2(getCtx('c2'));
    renderV9(getCtx('c9')); // New Template
    renderV3(getCtx('c3'));
    renderV4(getCtx('c4'));
    renderV5(getCtx('c5'));
    renderV6(getCtx('c6'));
    renderV7(getCtx('c7'));
    renderV8(getCtx('c8'));
    
    document.getElementById('gridArea').style.display = 'flex';
    btn.innerText = "–û–±–Ω–æ–≤–∏—Ç—å";
    document.getElementById('gridArea').scrollIntoView({ behavior: 'smooth' });
  }

  async function shareCanvas(id) {
    const canvas = document.getElementById(id);
    const blob = await new Promise(r => canvas.toBlob(r, 'image/png'));
    const file = new File([blob], "design_pro.png", { type: "image/png" });
    if (navigator.share && navigator.canShare({ files: [file] })) {
      try { await navigator.share({ files: [file], title: 'CSG Design' }); } 
      catch (err) { console.log(err); }
    } else {
      const a = document.createElement('a');
      a.download = 'design.png'; a.href = canvas.toDataURL(); a.click();
    }
  }

  document.getElementById('renderBtn').addEventListener('click', generate);

  window.onload = () => {
    ['c1','c2','c9','c3','c4','c5','c6','c7','c8'].forEach(id => {
       const ctx = getCtx(id);
       ctx.fillStyle='#111'; ctx.fillRect(0,0,W,H);
       ctx.fillStyle='#333'; ctx.font=`700 40px ${FONT_INTER}`;
       ctx.textAlign='center'; ctx.fillText("Preview", W/2, H/2);
    });
  };
</script>
</body>
</html>
