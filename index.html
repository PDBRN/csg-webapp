<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
  <title>CSG Stories</title>
  
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Manrope:wght@400;700;800&family=Merriweather:wght@400;700;900&family=Cormorant+Garamond:wght@700&display=swap" rel="stylesheet">

  <style>
    :root {
      --bg: #09090b;
      --panel: #18181b;
      --border: #27272a;
      --primary: #f59e0b; 
      --text: #f4f4f5;
      --text-dim: #a1a1aa;
      --font-ui: 'Inter', sans-serif;
    }

    * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
    
    body {
      margin: 0;
      background-color: var(--bg);
      color: var(--text);
      font-family: var(--font-ui);
      padding: 0;
    }

    .app-wrapper {
      display: flex;
      flex-direction: column;
      width: 100%;
      /* Increased padding so button doesn't overlap content */
      padding-bottom: 160px;
    }

    /* Sidebar */
    .sidebar {
      background: var(--panel);
      padding: 20px;
      border-bottom: 1px solid var(--border);
    }

    .header { margin-bottom: 20px; }
    .header h1 { margin: 0; font-size: 18px; font-weight: 700; color: #fff; }
    .header p { margin: 4px 0 0 0; color: var(--text-dim); font-size: 12px; }

    .control-group { margin-bottom: 20px; }
    .control-group label { display: block; margin-bottom: 8px; font-size: 12px; font-weight: 600; color: var(--text-dim); text-transform: uppercase; letter-spacing: 0.5px; }

    input[type="text"], textarea, select {
      width: 100%;
      background: #0f0f11;
      border: 1px solid var(--border);
      color: var(--text);
      padding: 12px;
      border-radius: 12px;
      font-family: inherit;
      font-size: 14px;
      margin-bottom: 8px;
    }
    textarea { resize: none; height: 80px; }

    /* File Drop */
    .file-drop {
      border: 1px dashed var(--border);
      border-radius: 12px;
      padding: 16px;
      text-align: center;
      background: rgba(255,255,255,0.02);
      cursor: pointer;
      transition: 0.2s;
    }
    .file-drop:active { background: rgba(255,255,255,0.05); }
    .file-drop span { font-size: 13px; color: var(--primary); font-weight: 500; }
    input[type="file"] { display: none; }

    /* Logo Presets */
    .logo-grid { display: flex; flex-wrap: wrap; gap: 8px; }
    .logo-btn {
      background: #27272a;
      border: 1px solid transparent;
      color: #fff;
      padding: 8px 12px;
      border-radius: 8px;
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      flex: 1 1 auto;
      text-align: center;
      transition: 0.2s;
    }
    .logo-btn.active { background: var(--primary); color: #000; font-weight: 700; }
    .logo-btn:active { transform: scale(0.95); }

    /* Color Picker */
    .row { display: flex; gap: 12px; align-items: center; }
    .color-wrapper {
      position: relative;
      width: 50px; height: 50px;
      border-radius: 50%; overflow: hidden;
      border: 2px solid var(--border);
      flex-shrink: 0;
    }
    input[type="color"] {
      position: absolute; top: -50%; left: -50%;
      width: 200%; height: 200%;
      padding: 0; margin: 0; border: none; cursor: pointer;
    }

    /* Generate Button */
    .btn-generate {
      position: fixed; bottom: 20px; left: 20px;
      width: calc(100% - 40px);
      background: var(--primary); color: #000;
      border: none; padding: 16px;
      border-radius: 16px;
      font-weight: 800; font-size: 16px;
      cursor: pointer;
      box-shadow: 0 10px 30px rgba(0,0,0,0.5);
      z-index: 100; text-transform: uppercase;
      letter-spacing: 1px;
    }
    .btn-generate:active { transform: scale(0.98); }

    /* Preview Grid */
    .preview-grid { 
      padding: 20px; 
      display: flex; 
      flex-direction: column; 
      gap: 40px; 
      /* Extra padding at bottom for scrolling past button */
      padding-bottom: 120px; 
    }
    .card { background: var(--panel); border: 1px solid var(--border); border-radius: 16px; padding: 10px; }
    .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; padding: 0 4px; }
    .card-title { font-size: 14px; font-weight: 700; color: #fff; }
    .badge { font-size: 10px; background: #27272a; padding: 4px 8px; border-radius: 6px; color: #aaa; text-transform: uppercase; font-weight: 600; }
    
    canvas { width: 100%; height: auto; border-radius: 8px; display: block; background: #000; margin-bottom: 12px; }
    .btn-share { background: #3f3f46; color: #fff; border: none; width: 100%; padding: 14px; border-radius: 10px; font-weight: 600; font-size: 14px; cursor: pointer; transition: background 0.2s; }
    .btn-share:hover { background: #52525b; }
    .btn-share:active { transform: scale(0.98); }
  </style>
</head>
<body>

<div class="app-wrapper">
  <!-- SETTINGS -->
  <div class="sidebar">
    <div class="header">
      <h1>CSG Stories</h1>
      <p>v 4.1(android?)</p>
    </div>

    <!-- 1. PHOTOS -->
    <div class="control-group">
      <label>1. –§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ (–¥–æ 4 —à—Ç)</label>
      <div class="file-drop" onclick="document.getElementById('imgInput').click()">
        <span id="fileLabel">üì∏ –ù–∞–∂–º–∏, —á—Ç–æ–±—ã –≤—ã–±—Ä–∞—Ç—å —Ñ–æ—Ç–æ</span>
        <input type="file" id="imgInput" multiple accept="image/*" onchange="updateFileLabel(this)">
      </div>
    </div>

    <!-- 2. LOGO PRESETS -->
    <div class="control-group">
      <label>2. –õ–æ–≥–æ—Ç–∏–ø</label>
      <div class="logo-grid" id="logoContainer">
        <button class="logo-btn active" onclick="selectLogo(this, 'none')">–ù–µ—Ç</button>
        <button class="logo-btn" onclick="selectLogo(this, 'csg')">–¶–°–ì</button>
        <button class="logo-btn" onclick="selectLogo(this, 'mstore')">M-Store</button>
        <button class="logo-btn" onclick="selectLogo(this, 'pss')">–ü–°–°</button>
        <button class="logo-btn" onclick="selectLogo(this, 'cm')">–¶–ú</button>
        <button class="logo-btn" onclick="selectLogo(this, 'polymers')">–ü–æ–ª–∏–º–µ—Ä—ã</button>
        <button class="logo-btn" onclick="selectLogo(this, 'horeca')">–•–æ—Ä–µ–∫–∞</button>
        <button class="logo-btn" onclick="selectLogo(this, 'custom')">–°–≤–æ–π...</button>
      </div>
      <input type="file" id="customLogoInput" accept="image/*" style="display:none" onchange="handleCustomLogo(this)">
    </div>

    <!-- 3. TEXT -->
    <div class="control-group">
      <label>3. –ö–æ–Ω—Ç–µ–Ω—Ç</label>
      <input type="text" id="txtTitle" placeholder="–ó–∞–≥–æ–ª–æ–≤–æ–∫" value="–ù–æ–≤–æ–≥–æ–¥–Ω—è—è —Ä–∞—Å–ø—Ä–æ–¥–∞–∂–∞">
      <textarea id="txtDesc" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ">–°–∫–∏–¥–∫–∏ –¥–æ 20% –Ω–∞ –≤–µ—Å—å –∞—Å—Å–æ—Ä—Ç–∏–º–µ–Ω—Ç. –£—Å–ø–µ–π—Ç–µ –∑–∞–∫–∞–∑–∞—Ç—å –¥–æ 31 –¥–µ–∫–∞–±—Ä—è!</textarea>
      <input type="text" id="txtBtn" placeholder="–¢–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏" value="–ü–æ–ª—É—á–∏—Ç—å –ø—Ä–∞–π—Å üéÑ">
    </div>

    <!-- 4. STYLE -->
    <div class="row control-group">
      <div>
        <label>–¶–≤–µ—Ç</label>
        <div class="color-wrapper">
          <input type="color" id="accentColor" value="#f59e0b">
        </div>
      </div>
      <div style="flex-grow: 1;">
        <label>–§–æ–Ω</label>
        <select id="bgStyle">
          <option value="blur">–†–∞–∑–º—ã—Ç–æ–µ —Ñ–æ—Ç–æ</option>
          <option value="dark">–¢—ë–º–Ω—ã–π</option>
          <option value="clean">–°–≤–µ—Ç–ª—ã–π</option>
        </select>
      </div>
    </div>
  </div>

  <!-- PREVIEWS (ORDERED) -->
  <div class="preview-grid" id="gridArea" style="display:none;">
    
    <div class="card"><div class="card-header"><span class="card-title">V1. Classic Hero</span><span class="badge">1 –§–æ—Ç–æ</span></div><canvas id="c1" width="1080" height="1920"></canvas><button class="btn-share" onclick="shareCanvas('c1')">–°–∫–∞—á–∞—Ç—å</button></div>
    
    <div class="card"><div class="card-header"><span class="card-title">V2. Smart Grid</span><span class="badge">1-4 –§–æ—Ç–æ</span></div><canvas id="c2" width="1080" height="1920"></canvas><button class="btn-share" onclick="shareCanvas('c2')">–°–∫–∞—á–∞—Ç—å</button></div>
    
    <div class="card"><div class="card-header"><span class="card-title">V3. Big Bold</span><span class="badge">–ö—Ä—É–ø–Ω—ã–π —Ç–µ–∫—Å—Ç</span></div><canvas id="c3" width="1080" height="1920"></canvas><button class="btn-share" onclick="shareCanvas('c3')">–°–∫–∞—á–∞—Ç—å</button></div>
    
    <div class="card"><div class="card-header"><span class="card-title">V4. Product Card</span><span class="badge">–ö–∞—Ä—Ç–æ—á–∫–∞</span></div><canvas id="c4" width="1080" height="1920"></canvas><button class="btn-share" onclick="shareCanvas('c4')">–°–∫–∞—á–∞—Ç—å</button></div>
    
    <div class="card"><div class="card-header"><span class="card-title">V9. Gallery</span><span class="badge">–ì–∞–ª–µ—Ä–µ—è</span></div><canvas id="c9" width="1080" height="1920"></canvas><button class="btn-share" onclick="shareCanvas('c9')">–°–∫–∞—á–∞—Ç—å</button></div>

    <div class="card"><div class="card-header"><span class="card-title">V10. Classic New Year</span><span class="badge">Red & Snow</span></div><canvas id="c10" width="1080" height="1920"></canvas><button class="btn-share" onclick="shareCanvas('c10')">–°–∫–∞—á–∞—Ç—å</button></div>

    <div class="card"><div class="card-header"><span class="card-title">V11. Clean Catalog (FIXED)</span><span class="badge">–ö–∞—Ç–∞–ª–æ–≥</span></div><canvas id="c11" width="1080" height="1920"></canvas><button class="btn-share" onclick="shareCanvas('c11')">–°–∫–∞—á–∞—Ç—å</button></div>

    <div class="card"><div class="card-header"><span class="card-title">V12. Golden Luxury</span><span class="badge">–ó–æ–ª–æ—Ç–æ</span></div><canvas id="c12" width="1080" height="1920"></canvas><button class="btn-share" onclick="shareCanvas('c12')">–°–∫–∞—á–∞—Ç—å</button></div>

    <div class="card"><div class="card-header"><span class="card-title">V13. Neon Frost</span><span class="badge">–°—Ç–µ–∫–ª–æ</span></div><canvas id="c13" width="1080" height="1920"></canvas><button class="btn-share" onclick="shareCanvas('c13')">–°–∫–∞—á–∞—Ç—å</button></div>
  </div>

  <button class="btn-generate" id="renderBtn">–°–æ–∑–¥–∞—Ç—å –º–∞–∫–µ—Ç—ã</button>
</div>

<script>
  // --- CONFIG ---
  const tg = window.Telegram.WebApp;
  tg.ready(); tg.expand();
  tg.setHeaderColor('#18181b'); tg.setBackgroundColor('#09090b');

  const LOGO_URLS = {
    'none': null,
    'csg': 'https://pdbrn.github.io/csg-webapp/assets/logo_csg.png',
    'mstore': 'https://pdbrn.github.io/csg-webapp/assets/logo_mstore.png',
    'pss': 'https://pdbrn.github.io/csg-webapp/assets/logo_pss.png',
    'cm': 'https://pdbrn.github.io/csg-webapp/assets/logo_cm.png',
    'polymers': 'https://pdbrn.github.io/csg-webapp/assets/logo_polymers.png',
    'horeca': 'https://pdbrn.github.io/csg-webapp/assets/logo_horeca.png'
  };

  const W = 1080, H = 1920;
  const FONT_MANROPE = "'Manrope', sans-serif";
  const FONT_INTER = "'Inter', sans-serif";
  const FONT_SERIF = "'Merriweather', serif";
  const FONT_GOLD = "'Cormorant Garamond', serif";

  const state = {
    images: [],
    logo: null,
    title: "", desc: "", cta: "", accent: "#f59e0b",
  };

  // --- UI HANDLERS ---
  function updateFileLabel(input) {
    document.getElementById('fileLabel').innerText = input.files.length 
      ? `–í—ã–±—Ä–∞–Ω–æ —Ñ–∞–π–ª–æ–≤: ${input.files.length}` : "üì∏ –ù–∞–∂–º–∏, —á—Ç–æ–±—ã –≤—ã–±—Ä–∞—Ç—å —Ñ–æ—Ç–æ";
  }

  async function selectLogo(btn, key) {
    document.querySelectorAll('.logo-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    if (key === 'custom') { document.getElementById('customLogoInput').click(); return; }
    state.logo = (key === 'none') ? null : await loadImage(LOGO_URLS[key]);
  }

  async function handleCustomLogo(input) {
    if(input.files && input.files[0]) {
      state.logo = await loadImage(URL.createObjectURL(input.files[0]));
      document.querySelector('.logo-btn[onclick*="custom"]').innerText = "–ó–∞–≥—Ä—É–∂–µ–Ω–æ";
      document.querySelector('.logo-btn[onclick*="custom"]').classList.add('active');
    }
  }

  // --- CORE DRAWING HELPERS ---
  function getCtx(id) {
    const c = document.getElementById(id);
    const ctx = c.getContext('2d', { alpha: false });
    ctx.filter = 'none'; ctx.globalAlpha = 1; ctx.setTransform(1, 0, 0, 1, 0, 0); 
    return ctx;
  }
  
  function loadImage(src) {
    return new Promise((r) => {
      const img = new Image(); img.crossOrigin = "anonymous";
      img.onload = () => r(img); img.onerror = () => r(null); img.src = src;
    });
  }

  function wrapText(ctx, text, maxWidth) {
    if(!text) return [];
    const words = text.split(' ');
    let lines = [], currentLine = words[0];
    for (let i = 1; i < words.length; i++) {
      const w = ctx.measureText(currentLine + " " + words[i]).width;
      if (w < maxWidth) currentLine += " " + words[i];
      else { lines.push(currentLine); currentLine = words[i]; }
    }
    lines.push(currentLine);
    return lines;
  }

  function drawImageCover(ctx, img, x, y, w, h, r=0) {
    if (!img) return;
    ctx.save();
    if (r > 0) { ctx.beginPath(); ctx.roundRect(x, y, w, h, r); ctx.clip(); }
    const scale = Math.max(w / img.width, h / img.height);
    const tx = x + (w - img.width * scale) / 2;
    const ty = y + (h - img.height * scale) / 2;
    ctx.drawImage(img, tx, ty, img.width * scale, img.height * scale);
    ctx.restore();
  }

  function drawSmartGrid(ctx, imgs, x, y, w, h, gap=0, r=0) {
     if(!imgs || imgs.length === 0) {
       ctx.fillStyle = '#222'; ctx.fillRect(x,y,w,h); return;
     }
     const count = Math.min(imgs.length, 4);

     if(count === 1) {
       drawImageCover(ctx, imgs[0], x, y, w, h, r);
     } 
     else if(count === 2) {
       const halfH = (h - gap)/2;
       drawImageCover(ctx, imgs[0], x, y, w, halfH, r);
       drawImageCover(ctx, imgs[1], x, y + halfH + gap, w, halfH, r);
     } 
     else if(count === 3) {
       const bigH = h * 0.6;
       const smallH = h - bigH - gap;
       const smallW = (w - gap) / 2;
       drawImageCover(ctx, imgs[0], x, y, w, bigH, r);
       drawImageCover(ctx, imgs[1], x, y + bigH + gap, smallW, smallH, r);
       drawImageCover(ctx, imgs[2], x + smallW + gap, y + bigH + gap, smallW, smallH, r);
     } 
     else if(count === 4) {
       const halfW = (w - gap)/2;
       const halfH = (h - gap)/2;
       drawImageCover(ctx, imgs[0], x, y, halfW, halfH, r);
       drawImageCover(ctx, imgs[1], x + halfW + gap, y, halfW, halfH, r);
       drawImageCover(ctx, imgs[2], x, y + halfH + gap, halfW, halfH, r);
       drawImageCover(ctx, imgs[3], x + halfW + gap, y + halfH + gap, halfW, halfH, r);
     }
  }

  function drawLogoBookmark(ctx, xCenter) {
    if (!state.logo) return;
    const tagW = 200, tagH = 140, r = 20;
    const x = xCenter - tagW/2;
    ctx.save();
    ctx.fillStyle = '#ffffff'; 
    ctx.shadowColor = 'rgba(0,0,0,0.3)'; ctx.shadowBlur = 20;
    ctx.beginPath(); ctx.moveTo(x, 0); ctx.lineTo(x + tagW, 0); ctx.lineTo(x + tagW, tagH - r);
    ctx.arcTo(x + tagW, tagH, x + tagW - r, tagH, r); ctx.lineTo(x + r, tagH);
    ctx.arcTo(x, tagH, x, tagH - r, r); ctx.closePath(); ctx.fill(); 
    ctx.shadowBlur = 0;
    
    const pad = 25;
    const maxWidth = tagW - pad*2;
    const maxHeight = tagH - pad*2;
    const scale = Math.min(maxWidth/state.logo.width, maxHeight/state.logo.height);
    const fw = state.logo.width * scale, fh = state.logo.height * scale;
    ctx.drawImage(state.logo, x+(tagW-fw)/2, (tagH-fh)/2, fw, fh);
    ctx.restore();
  }

  function drawBackground(ctx) {
    const mode = document.getElementById('bgStyle').value;
    if (mode === 'clean') { ctx.fillStyle = '#e5e7eb'; ctx.fillRect(0,0,W,H); }
    else if (mode === 'blur' && state.images[0]) {
      ctx.drawImage(state.images[0], 0, 0, W, H);
      ctx.fillStyle = 'rgba(15,15,20,0.85)'; ctx.fillRect(0,0,W,H);
    } else { ctx.fillStyle = '#111'; ctx.fillRect(0,0,W,H); }
  }

  // --- RENDERERS ---

  // V1
  function renderV1(ctx) {
    drawBackground(ctx);
    if(state.images[0]) {
      drawImageCover(ctx, state.images[0], 0, 0, W, H);
      const g = ctx.createLinearGradient(0, H/2, 0, H);
      g.addColorStop(0, 'rgba(0,0,0,0)'); g.addColorStop(1, '#000');
      ctx.fillStyle = g; ctx.fillRect(0,0,W,H);
    }
    drawLogoBookmark(ctx, W/2);
    let y = H - 120; const pad = 60;
    if (state.cta) {
      ctx.font = `700 40px ${FONT_INTER}`;
      const btnW = ctx.measureText(state.cta).width + 80;
      y -= 100;
      ctx.fillStyle = state.accent;
      ctx.beginPath(); ctx.roundRect(pad, y, btnW, 100, 20); ctx.fill();
      ctx.fillStyle = '#000'; ctx.textAlign='center'; ctx.textBaseline='middle';
      ctx.fillText(state.cta, pad+btnW/2, y+50); y -= 50;
    }
    if(state.desc) {
      ctx.font = `500 42px ${FONT_INTER}`; ctx.fillStyle = '#d4d4d8'; ctx.textAlign='left';
      wrapText(ctx, state.desc, W-(pad*2)).reverse().forEach(l => { y -= 60; ctx.fillText(l, pad, y); }); y -= 30;
    }
    if(state.title) {
      ctx.font = `800 85px ${FONT_MANROPE}`; ctx.fillStyle = '#fff';
      wrapText(ctx, state.title, W-(pad*2)).reverse().forEach(l => { y -= 95; ctx.fillText(l, pad, y); });
    }
  }

  // V2
  function renderV2(ctx) {
    ctx.fillStyle = '#09090b'; ctx.fillRect(0,0,W,H);
    const pad = 40; const gridH = H * 0.55;
    drawSmartGrid(ctx, state.images, pad, pad, W-pad*2, gridH, 15, 12);
    drawLogoBookmark(ctx, W/2);
    let ty = gridH + 100; const maxW = W - 120;
    ctx.textAlign = 'center'; ctx.textBaseline='top';
    if(state.title) {
      ctx.font = `800 75px ${FONT_MANROPE}`; ctx.fillStyle='#fff';
      wrapText(ctx, state.title, maxW).forEach(l => { ctx.fillText(l, W/2, ty); ty+=85; });
    }
    if(state.desc) {
      ty+=30; ctx.font=`400 38px ${FONT_INTER}`; ctx.fillStyle='#a1a1aa';
      wrapText(ctx, state.desc, maxW).forEach(l => { ctx.fillText(l, W/2, ty); ty+=50; });
    }
    if(state.cta) {
      ty+=60; ctx.font=`700 42px ${FONT_INTER}`; ctx.fillStyle=state.accent;
      const btnW = ctx.measureText(state.cta).width;
      ctx.fillText(state.cta, W/2, ty);
      ctx.fillRect(W/2 - btnW/2, ty+55, btnW, 4);
    }
  }

  // V3
  function renderV3(ctx) {
    if(state.images[0]) {
      drawImageCover(ctx, state.images[0], 0,0,W,H);
      ctx.fillStyle = 'rgba(0,0,0,0.85)'; ctx.fillRect(0,0,W,H);
    } else { ctx.fillStyle='#111'; ctx.fillRect(0,0,W,H); }
    drawLogoBookmark(ctx, W/2);
    ctx.textAlign='center'; ctx.textBaseline='middle';
    let ty = H/2 - 80;
    if(state.title) {
      ctx.font = `900 110px ${FONT_MANROPE}`; ctx.fillStyle='#fff';
      wrapText(ctx, state.title.toUpperCase(), W-80).forEach(l => { ctx.fillText(l, W/2, ty); ty+=120; });
    }
    ctx.fillStyle = state.accent; ctx.fillRect(W/2-60, ty, 120, 10); ty+=100;
    if(state.desc) {
      ctx.font = `500 44px ${FONT_INTER}`; ctx.fillStyle='#ccc';
      wrapText(ctx, state.desc, W-160).forEach(l => { ctx.fillText(l, W/2, ty); ty+=60; });
    }
    if(state.cta) {
      const btnY = H - 250;
      ctx.save(); ctx.translate(W/2, btnY); ctx.font=`700 40px ${FONT_INTER}`;
      const btnW = ctx.measureText(state.cta).width + 120;
      ctx.transform(1,0,-0.2,1,0,0); 
      ctx.fillStyle=state.accent; ctx.fillRect(-btnW/2, -50, btnW, 100);
      ctx.setTransform(1,0,0,1,W/2,btnY); 
      ctx.fillStyle='#000'; ctx.fillText(state.cta, 0, 5);
      ctx.restore();
    }
  }

  // V4
  function renderV4(ctx) {
     drawBackground(ctx);
     const cX=60, cY=(H*0.15), cW=W-120, cH=H*0.7;
     const isLight = document.getElementById('bgStyle').value === 'clean';
     const cardBg = isLight ? '#ffffff' : '#18181b';
     const textColor = isLight ? '#000000' : '#ffffff';
     const descColor = isLight ? '#555555' : '#a1a1aa';

     ctx.shadowColor='rgba(0,0,0,0.5)'; ctx.shadowBlur=40;
     ctx.fillStyle = cardBg;
     ctx.beginPath(); ctx.roundRect(cX, cY, cW, cH, 30); ctx.fill(); ctx.shadowBlur=0;
     ctx.save(); ctx.clip();
     
     const imgH = cH * 0.55;
     if(state.images.length > 0) {
        drawImageCover(ctx, state.images[0], cX, cY, cW, imgH);
     } else {
        ctx.fillStyle = '#333'; ctx.fillRect(cX, cY, cW, imgH);
     }
     
     ctx.fillStyle = cardBg;
     ctx.fillRect(cX, cY + imgH, cW, cH - imgH);

     let ty = cY + imgH + 60;
     const tx = cX + 50, tW = cW - 100;
     ctx.textAlign='left'; ctx.textBaseline='top';
     
     if(state.title) {
       ctx.fillStyle = textColor; ctx.font = `800 55px ${FONT_MANROPE}`;
       wrapText(ctx, state.title, tW).forEach(l => { ctx.fillText(l, tx, ty); ty+=65; });
     }
     if(state.desc) {
       ty+=20; ctx.fillStyle = descColor; ctx.font = `400 36px ${FONT_INTER}`;
       wrapText(ctx, state.desc, tW).slice(0,3).forEach(l => { ctx.fillText(l, tx, ty); ty+=48; });
     }
     
     if(state.cta) {
       const btnY = cY + cH - 130;
       ctx.fillStyle=state.accent; ctx.beginPath(); ctx.roundRect(tx, btnY, tW, 90, 16); ctx.fill();
       ctx.fillStyle='#000'; ctx.textAlign='center'; ctx.textBaseline='middle';
       ctx.font=`700 32px ${FONT_INTER}`; ctx.fillText(state.cta, tx+tW/2, btnY+45);
     }
     ctx.restore();
     drawLogoBookmark(ctx, W/2);
  }

  // V9
  function renderV9(ctx) {
    ctx.fillStyle='#09090b'; ctx.fillRect(0,0,W,H);
    const imgs = state.images;
    const bigH = H * 0.50;
    const gap = 20;
    
    if(imgs[0]) drawImageCover(ctx, imgs[0], 0, 0, W, bigH);

    const startY = bigH + gap;
    const stripH = H * 0.15;
    const remain = Math.min(imgs.length - 1, 3);
    
    if(remain > 0) {
       const w = (W - gap * (remain + 1)) / remain;
       for(let i=0; i<remain; i++) {
          drawImageCover(ctx, imgs[i+1], gap + i*(w+gap), startY, w, stripH, 12);
       }
    } else {
       ctx.fillStyle='#18181b'; ctx.fillRect(gap, startY, W-gap*2, 10);
    }
    
    drawLogoBookmark(ctx, W/2);
    
    let ty = startY + stripH + 60;
    ctx.textAlign = 'center'; ctx.textBaseline='top';
    const maxW = W-120;

    if(state.title) {
        ctx.fillStyle='#fff'; ctx.font=`800 75px ${FONT_MANROPE}`;
        wrapText(ctx, state.title, maxW).forEach(l => { ctx.fillText(l, W/2, ty); ty+=85; });
    }
    if(state.desc) {
        ty+=20; ctx.fillStyle='#a1a1aa'; ctx.font=`500 38px ${FONT_INTER}`;
        wrapText(ctx, state.desc, maxW).slice(0,3).forEach(l => { ctx.fillText(l, W/2, ty); ty+=50; });
    }
    
    if(state.cta) {
        ty+=50;
        if (ty + 110 > H) ty = H - 150; 
        
        ctx.fillStyle=state.accent; 
        const btnW = ctx.measureText(state.cta).width + 120;
        ctx.beginPath(); ctx.roundRect(W/2 - btnW/2, ty, btnW, 110, 55); ctx.fill();
        ctx.fillStyle='#000'; ctx.font=`700 38px ${FONT_INTER}`; ctx.textBaseline='middle';
        ctx.fillText(state.cta, W/2, ty+55);
    }
  }

  // V10
  function renderV10(ctx) {
    const g = ctx.createLinearGradient(0,0,0,H);
    g.addColorStop(0, '#7f1d1d'); g.addColorStop(1, '#250505');
    ctx.fillStyle = g; ctx.fillRect(0,0,W,H);
    if(state.images[0]) {
      const p = 40;
      drawImageCover(ctx, state.images[0], p, 220, W-p*2, H*0.45, 20);
      ctx.strokeStyle = '#ef4444'; ctx.lineWidth=2; 
      ctx.strokeRect(p+10, 230, W-p*2-20, H*0.45-20);
    }
    ctx.fillStyle = '#fff';
    for(let i=0; i<80; i++) {
        const x = Math.random()*W, y = Math.random()*H, s = Math.random()*4;
        ctx.globalAlpha = Math.random()*0.6; ctx.beginPath(); ctx.arc(x,y,s,0,Math.PI*2); ctx.fill();
    }
    ctx.globalAlpha = 1;
    drawLogoBookmark(ctx, W/2);
    let ty = H*0.5 + 280;
    ctx.textAlign='center'; ctx.textBaseline='top';
    ctx.font = `italic 700 50px ${FONT_SERIF}`; ctx.fillStyle = '#fca5a5';
    ctx.fillText("‚ú® –° –ù–æ–≤—ã–º –ì–æ–¥–æ–º! ‚ú®", W/2, ty - 80);
    if(state.title) {
        ctx.fillStyle='#fff'; ctx.font=`700 85px ${FONT_SERIF}`;
        wrapText(ctx, state.title, W-100).forEach(l => { ctx.fillText(l, W/2, ty); ty+=95; });
    }
    if(state.desc) {
        ty+=20; ctx.fillStyle='#e5e5e5'; ctx.font=`400 38px ${FONT_SERIF}`;
        wrapText(ctx, state.desc, W-140).forEach(l => { ctx.fillText(l, W/2, ty); ty+=50; });
    }
    if(state.cta) {
        ty+=60; const btnW = ctx.measureText(state.cta).width + 120;
        ctx.fillStyle='#fff'; ctx.beginPath(); ctx.roundRect(W/2 - btnW/2, ty, btnW, 100, 16); ctx.fill();
        ctx.fillStyle='#b91c1c'; ctx.font=`700 36px ${FONT_INTER}`; ctx.textBaseline='middle';
        ctx.fillText(state.cta, W/2, ty+50);
    }
  }

  // V11 FIXED for Single Image + Grid
  function renderV11(ctx) {
     ctx.fillStyle = '#000'; ctx.fillRect(0,0,W,H);
     
     const count = Math.min(state.images.length, 4);
     const imgH = H * 0.70; 
     
     if (count <= 1) {
       // Single Image Mode (No dimming, clean look)
       if(state.images[0]) drawImageCover(ctx, state.images[0], 0, 0, W, imgH);
       else { ctx.fillStyle = '#222'; ctx.fillRect(0,0,W,imgH); }
     } else {
       // Multi Image Mode (Strips)
       const colW = W / count;
       for(let i=0; i<count; i++) {
          drawImageCover(ctx, state.images[i], i*colW, 0, colW, imgH);
          ctx.fillStyle = 'rgba(0,0,0,0.15)'; ctx.fillRect(i*colW, 0, colW, imgH);
          if(i > 0) { ctx.fillStyle='rgba(255,255,255,0.2)'; ctx.fillRect(i*colW, 0, 2, imgH); }
       }
     }
     
     drawLogoBookmark(ctx, W/2);
     
     ctx.fillStyle = '#111'; ctx.fillRect(0, imgH, W, H - imgH);
     ctx.fillStyle = state.accent; ctx.fillRect(0, imgH, W, 8); 
     
     let ty = imgH + 80;
     ctx.textAlign = 'center'; ctx.textBaseline='top';
     
     if(state.title) {
        ctx.fillStyle='#fff'; ctx.font=`800 70px ${FONT_MANROPE}`;
        wrapText(ctx, state.title, W-100).forEach(l => { ctx.fillText(l, W/2, ty); ty+=80; });
     }
     
     ty += 20;
     if(state.desc) {
        ctx.fillStyle='#a1a1aa'; ctx.font=`500 36px ${FONT_INTER}`;
        wrapText(ctx, state.desc, W-100).slice(0,2).forEach(l => { ctx.fillText(l, W/2, ty); ty+=45; });
     }
     
     if(state.cta) {
        ty += 50;
        const btnW = ctx.measureText(state.cta).width + 100;
        ctx.strokeStyle = '#444'; ctx.lineWidth=3;
        ctx.beginPath(); ctx.roundRect(W/2 - btnW/2, ty, btnW, 90, 12); ctx.stroke();
        ctx.fillStyle = state.accent; ctx.font=`700 34px ${FONT_INTER}`; 
        ctx.textBaseline='middle';
        ctx.fillText(state.cta, W/2, ty+45);
     }
  }

  // V12
  function renderV12(ctx) {
    ctx.fillStyle = '#0c0a09'; ctx.fillRect(0,0,W,H);
    if(state.images[0]) {
      const cx = W/2, cy = H*0.4, r = 400;
      ctx.save(); ctx.beginPath(); ctx.arc(cx, cy, r, 0, Math.PI*2); ctx.clip();
      drawImageCover(ctx, state.images[0], cx-r, cy-r, r*2, r*2);
      ctx.restore();
      ctx.strokeStyle = '#d4af37'; ctx.lineWidth = 4;
      ctx.beginPath(); ctx.arc(cx, cy, r+10, 0, Math.PI*2); ctx.stroke();
      ctx.lineWidth = 1; ctx.beginPath(); ctx.arc(cx, cy, r+25, 0, Math.PI*2); ctx.stroke();
    }
    drawLogoBookmark(ctx, W/2);
    ctx.fillStyle = '#d4af37';
    for(let x=40; x<W; x+=40) { ctx.fillRect(x, H-120, 2, 2); ctx.fillRect(x, 120, 2, 2); }
    let ty = H * 0.4 + 450;
    ctx.textAlign='center'; ctx.textBaseline='top';
    if(state.title) {
      ctx.font = `700 100px ${FONT_GOLD}`; 
      const grad = ctx.createLinearGradient(0, ty, W, ty);
      grad.addColorStop(0, '#bf953f'); grad.addColorStop(0.5, '#fcf6ba'); grad.addColorStop(1, '#bf953f');
      ctx.fillStyle = grad;
      wrapText(ctx, state.title.toUpperCase(), W-100).forEach(l => { ctx.fillText(l, W/2, ty); ty+=110; });
    }
    ctx.fillStyle = '#d4af37'; ctx.fillRect(W/2-50, ty+10, 100, 2); ty+=60;
    if(state.desc) {
      ctx.font = `400 42px ${FONT_SERIF}`; ctx.fillStyle = '#a8a29e';
      wrapText(ctx, state.desc, W-140).forEach(l => { ctx.fillText(l, W/2, ty); ty+=55; });
    }
    if(state.cta) {
      ty += 80; ctx.font = `700 40px ${FONT_MANROPE}`; ctx.fillStyle = '#d4af37';
      ctx.fillText(state.cta, W/2, ty);
    }
  }

  // V13
  function renderV13(ctx) {
    if(state.images[0]) {
       drawImageCover(ctx, state.images[0], 0,0,W,H);
       ctx.fillStyle = 'rgba(10,15,30, 0.8)'; ctx.fillRect(0,0,W,H);
    } else { ctx.fillStyle = '#0f172a'; ctx.fillRect(0,0,W,H); }
    const cardX = 60, cardW = W-120, cardH = H-300; const cardY = (H - cardH)/2;
    ctx.save();
    ctx.fillStyle = 'rgba(255,255,255,0.05)'; ctx.strokeStyle = 'rgba(255,255,255,0.2)'; ctx.lineWidth = 2;
    ctx.beginPath(); ctx.roundRect(cardX, cardY, cardW, cardH, 40); ctx.fill(); ctx.stroke();
    ctx.restore();
    if(state.images[0]) {
      drawImageCover(ctx, state.images[0], cardX+20, cardY+20, cardW-40, cardH*0.5, 30);
    }
    ctx.shadowColor = '#38bdf8'; ctx.shadowBlur = 20; ctx.fillStyle = '#38bdf8';
    ctx.beginPath(); ctx.arc(cardX+cardW-60, cardY+cardH*0.5, 40, 0, Math.PI*2); ctx.fill();
    ctx.shadowBlur = 0; ctx.fillStyle = '#fff';
    ctx.font = '40px serif'; ctx.textAlign='center'; ctx.textBaseline='middle';
    ctx.fillText('‚ùÑÔ∏è', cardX+cardW-60, cardY+cardH*0.5 + 2);
    let ty = cardY + cardH*0.5 + 80;
    ctx.textAlign = 'left'; ctx.textBaseline = 'top';
    const tx = cardX + 50; const tw = cardW - 100;
    if(state.title) {
       ctx.fillStyle = '#fff'; ctx.font = `800 70px ${FONT_MANROPE}`;
       wrapText(ctx, state.title, tw).forEach(l => { ctx.fillText(l, tx, ty); ty+=80; });
    }
    if(state.desc) {
       ty+=20; ctx.fillStyle = '#cbd5e1'; ctx.font = `500 36px ${FONT_INTER}`;
       wrapText(ctx, state.desc, tw).forEach(l => { ctx.fillText(l, tx, ty); ty+=45; });
    }
    if(state.cta) {
       const by = cardY + cardH - 120;
       ctx.shadowColor = state.accent; ctx.shadowBlur = 30;
       ctx.fillStyle = state.accent; ctx.beginPath(); ctx.roundRect(tx, by, tw, 80, 20); ctx.fill();
       ctx.shadowBlur = 0;
       ctx.fillStyle = '#000'; ctx.textAlign='center'; ctx.textBaseline='middle';
       ctx.font = `700 32px ${FONT_INTER}`; ctx.fillText(state.cta, tx + tw/2, by + 40);
    }
    drawLogoBookmark(ctx, W/2);
  }

  // --- ACTIONS ---
  async function generate() {
    const btn = document.getElementById('renderBtn');
    const oldText = btn.innerText;
    btn.innerText = "‚è≥ –†–∏—Å—É—é...";
    
    state.title = document.getElementById('txtTitle').value;
    state.desc = document.getElementById('txtDesc').value;
    state.cta = document.getElementById('txtBtn').value;
    state.accent = document.getElementById('accentColor').value;
    
    const files = document.getElementById('imgInput').files;
    if (files.length) {
      state.images = await Promise.all(Array.from(files).map(f => loadImage(URL.createObjectURL(f))));
    }
    
    await document.fonts.ready;

    renderV1(getCtx('c1'));
    renderV2(getCtx('c2'));
    renderV3(getCtx('c3'));
    renderV4(getCtx('c4'));
    renderV9(getCtx('c9'));
    renderV10(getCtx('c10'));
    renderV11(getCtx('c11'));
    renderV12(getCtx('c12'));
    renderV13(getCtx('c13'));
    
    document.getElementById('gridArea').style.display = 'flex';
    btn.innerText = oldText;
    
    // Smooth scroll slightly down
    setTimeout(() => document.querySelector('.preview-grid').scrollIntoView({ behavior: 'smooth', block: 'start' }), 100);
  }

  async function shareCanvas(id) {
    const canvas = document.getElementById(id);
    const btn = document.querySelector(`button[onclick="shareCanvas('${id}')"]`);
    const originalText = btn.innerText;
    
    // –í–∏–∑—É–∞–ª—å–Ω–∞—è –∏–Ω–¥–∏–∫–∞—Ü–∏—è
    btn.innerText = "–°–æ—Ö—Ä–∞–Ω—è—é...";
    
    try {
      // 1. –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º Canvas –≤ Blob (–¥–ª—è Android —ç—Ç–æ –∫—Ä–∏—Ç–∏—á–Ω–æ, DataURL —á–∞—Å—Ç–æ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç)
      const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/png', 1.0));
      
      // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —É–Ω–∏–∫–∞–ª—å–Ω–æ–µ –∏–º—è (—á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ –∏–º–µ–Ω —Ñ–∞–π–ª–æ–≤)
      const fileName = `csg_story_${Date.now()}.png`;
      const file = new File([blob], fileName, { type: "image/png" });

      // 2. –ü—Ä–æ–±—É–µ–º –Ω–∞—Ç–∏–≤–Ω—ã–π —à–µ—Ä–∏–Ω–≥ (–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç –¥–ª—è Android/iOS)
      if (navigator.share && navigator.canShare && navigator.canShare({ files: [file] })) {
        try {
          await navigator.share({
            files: [file],
            title: 'CSG Story',
            text: '–ú–∞–∫–µ—Ç —Å–æ–∑–¥–∞–Ω –≤ CSG Stories'
          });
          btn.innerText = originalText;
          return; // –£—Å–ø–µ—Ö, –≤—ã—Ö–æ–¥–∏–º
        } catch (err) {
          console.log('Share canceled/failed', err);
        }
      }

      // 3. –§–û–õ–õ–ë–≠–ö: –°–∫–∞—á–∏–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ Blob URL (–µ—Å–ª–∏ —à–µ—Ä–∏–Ω–≥ –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª –∏–ª–∏ —ç—Ç–æ –ü–ö)
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = fileName;
      link.style.display = 'none';
      document.body.appendChild(link);
      link.click();
      
      // –ß–∏—Å—Ç–∏–º –ø–∞–º—è—Ç—å
      setTimeout(() => {
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
      }, 100);

    } catch (e) {
      console.error("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:", e);
      alert("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–¥–µ–ª–∞—Ç—å —Å–∫—Ä–∏–Ω—à–æ—Ç.");
    } finally {
      btn.innerText = originalText;
    }
  }

  // –í–ê–ñ–ù–û: –≠—Ç–∏ —Å—Ç—Ä–æ—á–∫–∏ –¥–æ–ª–∂–Ω—ã –æ—Å—Ç–∞—Ç—å—Å—è, —á—Ç–æ–±—ã –∫–Ω–æ–ø–∫–∞ —Ä–∞–±–æ—Ç–∞–ª–∞!
  document.getElementById('renderBtn').addEventListener('click', generate);

  window.onload = () => {
    document.querySelectorAll('canvas').forEach(c => {
       const ctx = c.getContext('2d');
       ctx.fillStyle='#111'; ctx.fillRect(0,0,W,H);
       ctx.fillStyle='#333'; ctx.font=`700 40px ${FONT_INTER}`;
       ctx.textAlign='center'; ctx.textBaseline='middle';
       ctx.fillText("Preview", W/2, H/2);
    });
  };
</script>
</body>
</html>



